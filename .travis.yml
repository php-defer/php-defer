language: php

dist: trusty
sudo: false

php:
  - nightly
  - 7.4
  - 7.3
  - 7.2
  - 7.1
  - 7.0
  - 5.6
  - 5.5
  - 5.4

env:
  - COMPOSER_MEMORY_LIMIT=-1

matrix:
  include:
    - php: nightly
      dist: precise

  allow_failures:
    - php: nightly

install:
  - travis_retry composer update
  - |
    if [[ ${TRAVIS_PHP_VERSION:0:3} != "8.0" ]]; then
      cd dev-tools; travis_retry composer update; cd ..;
    fi
  - |
    if [[ ${TRAVIS_PHP_VERSION:0:3} == "7.1" ]]; then
      cd dev-tools;
      travis_retry composer require friendsofphp/php-cs-fixer:v2.16.1;
      cd ..;
      export RUN_CS_FIXER="true";
    fi

before_script:
  - vendor/bin/phpunit-4.8-fixer
  - composer show

script:
  - |
    if [[ "$RUN_CS_FIXER" = "true" ]]; then
      ./dev-tools/vendor/bin/php-cs-fixer --diff --dry-run -v --allow-risky=yes fix && ./dev-tools/vendor/bin/php-cs-fixer --diff --dry-run -v --allow-risky=yes fix .php_cs.dist;
    fi
  - vendor/bin/phpunit

after_script:
  - travis_retry bin/coveralls.sh
